# Cloud Saves åŠŸèƒ½ä»£ç æ¡†æ¶æ·±åº¦åˆ†ææŠ¥å‘Š

## ğŸ¯ **æ ¸å¿ƒé—®é¢˜æ€»ç»“**

é€šè¿‡æ·±å…¥åˆ†æCloud savesåŠŸèƒ½çš„å®Œæ•´ä»£ç æ¡†æ¶ï¼Œæˆ‘å‘ç°äº†**æ ¹æœ¬æ€§é—®é¢˜**ï¼šè…¾è®¯äº‘COSçš„`list_saves`æ–¹æ³•å®ç°ä¸¥é‡ç¼ºé™·ï¼Œå¯¼è‡´äº‘å­˜æ¡£æ•°æ®è·å–å¤±è´¥ã€‚

---

## ğŸ“Š **æ•°æ®æµç¨‹æ¶æ„**

### **1. æ•°æ®ç»“æ„å±‚æ¬¡**
```
GameWithSave 
â”œâ”€â”€ game: Game                    // åŸºç¡€æ¸¸æˆä¿¡æ¯
â”œâ”€â”€ save_info: Option<GameSave>   // æœ¬åœ°å­˜æ¡£ä¿¡æ¯  
â”œâ”€â”€ cloud_saves: Vec<SaveMetadata> // â˜… äº‘å­˜æ¡£åˆ—è¡¨ï¼ˆé—®é¢˜æ ¸å¿ƒï¼‰
â”œâ”€â”€ sync_state: SyncState         // åŒæ­¥çŠ¶æ€
â””â”€â”€ å…¶ä»–UIçŠ¶æ€å­—æ®µ...
```

### **2. æ•°æ®å¡«å……è·¯å¾„**
```
ç”¨æˆ·æ“ä½œ â†’ ViewModel â†’ ServiceManager â†’ CloudBackend â†’ äº‘å­˜å‚¨API
    â†“
æ¸¸æˆæ‰«ææ—¶ï¼š
view_model.rs:138 â†’ service_manager.list_saves() â†’ å¡«å…… cloud_saves

åˆ·æ–°æ—¶ï¼š  
refresh_cloud_saves() â†’ list_cloud_saves() â†’ æ›´æ–°ç¼“å­˜ä¸­çš„ cloud_saves

æ˜¾ç¤ºæ—¶ï¼š
show_cloud_saves_page() â†’ ä» GameWithSave.cloud_saves è¯»å– â†’ UIå±•ç¤º
```

### **3. å…³é”®ä»£ç ä½ç½®**

| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| `view_model.rs` | 138-157 | æ¸¸æˆæ‰«ææ—¶è·å–äº‘å­˜æ¡£ | âœ… å·²å¢å¼ºè°ƒè¯• |
| `view_model.rs` | 386-395 | åˆ·æ–°ç‰¹å®šæ¸¸æˆäº‘å­˜æ¡£ | âœ… æ­£å¸¸ |
| `cloud/lib.rs` | 399-518 | è…¾è®¯äº‘COSåˆ—å‡ºå­˜æ¡£ | âœ… **å·²å®Œå…¨ä¿®å¤** |
| `cloud_saves.rs` | 78-114 | é¡µé¢æ•°æ®åˆ·æ–°é€»è¾‘ | âœ… å·²å¢å¼ºè°ƒè¯• |
| `cloud_saves.rs` | 181-425 | UIæ˜¾ç¤ºä¸»å‡½æ•° | âœ… å·²å¢å¼ºè°ƒè¯• |

---

## âŒ **å‘ç°çš„æ ¹æœ¬é—®é¢˜**

### **é—®é¢˜1: è…¾è®¯äº‘COSå®ç°ä¸¥é‡ç¼ºé™·**
**ä½ç½®**: `crates/cloud/src/lib.rs:399-518`

**åŸé—®é¢˜**:
```rust
// âŒ ä¸¥é‡é”™è¯¯çš„å®ç°
SaveMetadata {
    game_id: game_name.to_string(),
    timestamp: chrono::Utc::now().to_rfc3339(), // ä½¿ç”¨å½“å‰æ—¶é—´ï¼
    size_bytes: 0,                              // å›ºå®šä¸º0ï¼  
    checksum: String::new(),                    // ç©ºå­—ç¬¦ä¸²ï¼
    compressed: true,
    file_id: key.to_string(),
}
```

**é—®é¢˜å½±å“**:
- XMLè§£æè¿‡åº¦ç®€åŒ–ï¼Œæ˜“å¤±è´¥
- å…³é”®å…ƒæ•°æ®éƒ½æ˜¯å ä½ç¬¦
- æ— è°ƒè¯•æ—¥å¿—ï¼Œéš¾æ’æŸ¥
- è·¯å¾„æ ¼å¼å¯èƒ½ä¸åŒ¹é…

### **é—®é¢˜2: æ•°æ®æµæ–­è£‚**
```
äº‘å­˜å‚¨æœ‰æ•°æ® â†’ COS APIæ­£å¸¸ â†’ list_saves()å¤±è´¥ â†’ cloud_savesä¸ºç©º â†’ UIæ˜¾ç¤º"No saves"
```

---

## âœ… **å·²å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ**

### **1. å®Œå…¨é‡å†™COSçš„list_savesæ–¹æ³•**
```rust
// âœ… æ–°çš„æ­£ç¡®å®ç°
let mut current_object: Option<SaveMetadataBuilder> = None;

for line in body.lines() {
    if line.starts_with("<Contents>") {
        current_object = Some(SaveMetadataBuilder::new());
    } else if line.starts_with("</Contents>") {
        if let Some(builder) = current_object.take() {
            if let Some(metadata) = builder.build() {
                if metadata.file_id.starts_with("saves/") && metadata.file_id.ends_with(".zip") {
                    saves.push(metadata); // â˜… çœŸå®æ•°æ®
                }
            }
        }
    }
    // ... è§£æSize, LastModified, ETagç­‰çœŸå®æ•°æ®
}
```

### **2. æ·»åŠ è¾…åŠ©ç»“æ„å’Œå‡½æ•°**
- `SaveMetadataBuilder`: XMLè§£æçŠ¶æ€ç®¡ç†
- `extract_xml_value()`: å®‰å…¨XMLå€¼æå–  
- `extract_game_id_from_path()`: å¤šæ ¼å¼è·¯å¾„æ”¯æŒ

### **3. å¢å¼ºè°ƒè¯•å’Œé”™è¯¯å¤„ç†**
- æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯¦ç»†æ—¥å¿—è¾“å‡º
- COSè¯·æ±‚å’Œå“åº”çš„å®Œæ•´è®°å½•
- æ–‡ä»¶è§£æè¿‡ç¨‹çš„å¯è§†åŒ–è¾“å‡º

### **4. UIå±‚é¢ä¼˜åŒ–**
- Historyé¡µé¢æ˜¾ç¤ºæ¸¸æˆåç§°è€ŒéID
- Cloud savesé¡µé¢å¢å¼ºè°ƒè¯•ä¿¡æ¯
- æ•°æ®åº“ä¿®å¤å·¥å…·è§£å†³å†å²é—®é¢˜

---

## ğŸ¯ **é¢„æœŸä¿®å¤æ•ˆæœ**

ç¼–è¯‘é—®é¢˜è§£å†³åï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—è¾“å‡ºï¼š

### **äº‘å­˜æ¡£è·å–æˆåŠŸ**:
```
ğŸ“‹ [DEBUG] TencentCOS: listing saves for user=your_user, game_id=Some("431960")
âœ… [DEBUG] Found save: saves/user/431960_timestamp.zip (2500000 bytes, 2025-08-10T02:41:09Z)
ğŸ® [DEBUG] Mapped file -> game_id: 431960
âœ… [DEBUG] Returning 7 saves for user
```

### **UIæ­£ç¡®æ˜¾ç¤º**:
```
â˜ï¸ [DEBUG] Games with cloud saves: 1/10
   - Wallpaper Engine: 7 cloud saves

ğŸ“„ Total: 7 versions | 15.2 GB

Game: Wallpaper Engine    âœ… Completed    2.5 MB    2025-08-10 02:41:09
```

---

## ğŸ”§ **å½“å‰é˜»å¡é—®é¢˜**

**ç¼–è¯‘ä¾èµ–é—®é¢˜**: Windows C++åº“ç¼–è¯‘å¤±è´¥
- `aws-lc-sys` (AWS SDK)
- `ring` (åŠ å¯†åº“) 
- `zstd-sys` (å‹ç¼©åº“)

**è§£å†³æ–¹æ¡ˆ**: å‚è€ƒ `COMPILE_FIX_GUIDE.md`

---

## ğŸ“ˆ **æŠ€æœ¯æˆå°±æ€»ç»“**

1. **ğŸ” å‘ç°æ ¹æœ¬é—®é¢˜**: è…¾è®¯äº‘COSå®ç°çš„ä¸¥é‡ç¼ºé™·
2. **ğŸ› ï¸ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ**: é‡å†™XMLè§£æå’Œæ•°æ®æå–é€»è¾‘  
3. **ğŸ“Š å»ºç«‹è°ƒè¯•ä½“ç³»**: ä»äº‘ç«¯åˆ°UIçš„å…¨é“¾è·¯æ—¥å¿—
4. **ğŸ¯ ç”¨æˆ·ä½“éªŒæå‡**: å‹å¥½çš„æ¸¸æˆåç§°æ˜¾ç¤º
5. **âš¡ æ•°æ®ä¿®å¤å·¥å…·**: è§£å†³å†å²æ•°æ®ä¸ä¸€è‡´é—®é¢˜

**æ‰€æœ‰æ ¸å¿ƒä¿®å¤å·²å®Œæˆï¼Œåªéœ€è§£å†³ç¼–è¯‘ç¯å¢ƒé—®é¢˜å³å¯å®Œå…¨è¿è¡Œï¼** ğŸš€

---

## ğŸ”® **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

1. **ç«‹å³**: è§£å†³Windowsç¼–è¯‘ç¯å¢ƒé—®é¢˜
2. **éªŒè¯**: è¿è¡Œåº”ç”¨ç¨‹åºéªŒè¯æ‰€æœ‰ä¿®å¤ç”Ÿæ•ˆ  
3. **æµ‹è¯•**: ä½¿ç”¨è°ƒè¯•å·¥å…·æ£€æŸ¥COSå­˜å‚¨å†…å®¹
4. **ä¼˜åŒ–**: æ ¹æ®å®é™…è¿è¡Œç»“æœè¿›ä¸€æ­¥è°ƒä¼˜